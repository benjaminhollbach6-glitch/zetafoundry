#!/data/data/com.termux/files/usr/bin/bash
set -Eeuo pipefail
HOST="${HOST:-127.0.0.1}"; PORT="${ZFX_PORT:-8785}"
TIMEOUT="${1:-30}"   # Sekunden
UVLOG="${UVLOG:-$HOME/neon/nx/projects/zetafoundry/logs/uvicorn.log}"

for i in $(seq 1 $((TIMEOUT*4))); do
  if curl -fsS "http://$HOST:$PORT/health" >/dev/null 2>&1; then
    echo "[OK] /health up (after $((i/4)).$((i%4*25))s)"
    exit 0
  fi
  sleep 0.25
done
echo "[ERR] /health down nach ${TIMEOUT}s" >&2
[ -f "$UVLOG" ] && tail -n 120 "$UVLOG" >&2 || true
exit 5
